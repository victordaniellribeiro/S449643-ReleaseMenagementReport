<!DOCTYPE html>
<html>
<head>
    <title>S449643-ReleaseMenagementReport</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID;this.projectId=e,console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"}),a=Ext.create("Ext.panel.Panel",{title:"Release Menagement Report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:a});var o=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",itemId:"releasaeComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){console.log("ready: ",e.getRecord());var t=[e.getRecord()];this._initReport(t)},select:function(e,t){console.log("comobo :",t),this._initReport(t)},scope:this}});t.add(o),this.add(t),this.add(a)},_initReport:function(e){console.log("records",e);var t=Ext.create("Ext.data.JsonStore",{fields:["projectName","exploring","elaborating","inprogress","staging","done","featureTotal","storyPointsAccepted","storyPointsInProgress","storyPointsPercentCompleted","defectsUnelaborated","defectsDefined","defectsInProgress","defectsCompleted","defectsAccepted","defectsReadyToShip","defectPointsAccepted","defectPointsInProgress"]});this.myMask.show();for(var a=[],o=0;o<e.length;o++){var s=Ext.create("Deft.Deferred"),r=o;e[r].get("ObjectID");this._createDataCall(e[r],s,this),a.push(s)}Deft.Promise.all(a).then({success:function(e){t.add(e[0]);var a=Ext.create("Ext.grid.Panel",{height:650,columns:[{text:"Project Name",flex:1,sortable:!0,dataIndex:"projectName"},{text:"Features",columns:[{text:"Exploring",width:75,sortable:!0,dataIndex:"exploring"},{text:"Elaborating",width:75,sortable:!0,dataIndex:"elaborating"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"inprogress"},{text:"Staging",width:75,sortable:!0,dataIndex:"staging"},{text:"Done",width:75,sortable:!0,dataIndex:"done"},{text:"Total of Features",width:100,sortable:!0,dataIndex:"featureTotal"}]},{text:"Stories",columns:[{text:"Story Points Accepted",width:120,sortable:!0,dataIndex:"storyPointsAccepted"},{text:"Story Points In-Progress",width:130,sortable:!0,dataIndex:"storyPointsInProgress"},{text:"Percent Story Points Completed",width:170,sortable:!0,dataIndex:"storyPointsPercentCompleted"}]},{text:"Defects",columns:[{text:"Unelaborated",width:80,sortable:!0,dataIndex:"defectsUnelaborated"},{text:"Defined",width:70,sortable:!0,dataIndex:"defectsDefined"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"defectsInProgress"},{text:"Completed",width:75,sortable:!0,dataIndex:"defectsCompleted"},{text:"Accepted",width:75,sortable:!0,dataIndex:"defectsAccepted"},{text:"Read to Ship",width:80,sortable:!0,dataIndex:"defectsReadyToShip"},{text:"Defect Points Accepted",width:130,sortable:!0,dataIndex:"defectPointsAccepted"},{text:"Defect Points In-Progress",width:150,sortable:!0,dataIndex:"defectPointsInProgress"}]}],flex:1,store:t});this.down("#mainPanel").removeAll(!0),this.down("#mainPanel").add(a),this.myMask.hide()},scope:this})},_createDataCall:function(e,t,a){new function(){this.releaseName=e.get("Name"),this.releaseId=e.get("ObjectID"),this.deferred=t,this.that=a;var o=a.getContext();this.projectId=o.getProject().ObjectID,this.execute=function(){console.log("executing call:",e),this._loadOrphanDefects(this.releaseName,this.projectId).then({success:function(e){return console.log("orphan:",e),this.orphanDefects=e,this._loadFeatures(this.releaseName)},scope:this}).then({success:function(e){return this.features=_.flatten(e),this._loadStories(e)},scope:this}).then({success:function(e){return console.log("success stories:",e),this.stories=_.flatten(e),this._loadDefects(e)},scope:this}).then({success:function(e){console.log("success defects:",e),this.defects=_.flatten(e);var o=[];a._createProjectMap(this.features,this.stories,this.defects,this.orphanDefects).eachKey(function(e,t){o.push(a._createRow(e,t))}),t.resolve(o)},scope:this})},this._loadFeatures=function(e){return console.log("Loading features for release:",e),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:"/project/"+this.projectId},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","Project","State","Type","UserStories"],filters:[{property:"Release.Name",operator:"=",value:e}],limit:1/0}).load()},this._loadStories=function(e){console.log("Features before loading stories:",e);var t=[];return _.each(e,function(e){var a=e.get("UserStories");a.Count>0&&(a.store=e.getCollection("UserStories",{fetch:["FormattedID","Name","ObjectID","Children","Defects","ScheduleState","Project","PlanEstimate","Type"]}),t.push(a.store.load()))}),Deft.Promise.all(t)},this._loadDefects=function(e){e=_.flatten(e),console.log("Stories before loading defects:",e);var t=[];return _.each(e,function(e){var a=e.get("Defects");a.Count>0&&(a.store=e.getCollection("Defects",{fetch:["FormattedID","Name","ObjectID","ScheduleState","Project","PlanEstimate","Blocked","Type","Parent"]}),t.push(a.store.load()))}),Deft.Promise.all(t)},this._loadOrphanDefects=function(e,t){return console.log("Loading orphan defects for release:",e),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+t},models:["Defect"],fetch:["FormattedID","Name","ObjectID","Project","PlanEstimate","ScheduleState","Type","Blocked","Parent"],filters:[{property:"Release.Name",operator:"=",value:e}],limit:1/0}).load()}}(e,t,a).execute()},_createProjectMap:function(e,t,a,o){var s=new Ext.util.MixedCollection;return _.each(e,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(t,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(a,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(o,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),s},_createRow:function(e,t){var a=0,o=0,s=0,r=0,n=0,c=0,i=0,d=0,l=0,h=0,p=0,f=0,g=0,u=0,m=0,x=0,P=0,S=0;return _.each(t,function(e){"portfolioitem/feature"==e.get("_type")&&null!=e.get("State")&&("Exploring"==e.get("State").Name?a+=1:"Elaborating"==e.get("State").Name?o+=1:"In-Progress"==e.get("State").Name?s+=1:"Staging"==e.get("State").Name?r+=1:"Done"==e.get("State").Name&&(n+=1),c+=1),"hierarchicalrequirement"==e.get("_type")&&("Accepted"==e.get("ScheduleState")||"Ready to Ship"==e.get("ScheduleState")?i+=e.get("PlanEstimate"):"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(d+=e.get("PlanEstimate")),h+=e.get("PlanEstimate")),"defect"==e.get("_type")&&("Unelaborated"==e.get("ScheduleState")?p+=1:"Defined"==e.get("ScheduleState")?(f+=1,S+=e.get("PlanEstimate")):"In-Progress"==e.get("ScheduleState")?(g+=1,S+=e.get("PlanEstimate")):"Completed"==e.get("ScheduleState")?u+=1:"Accepted"==e.get("ScheduleState")?(m+=1,P+=e.get("PlanEstimate")):"Ready to Ship"==e.get("ScheduleState")&&(x+=1))}),0!=h&&(l=Math.floor(i/h*100)+"%"),{projectName:e,exploring:a,elaborating:o,inprogress:s,staging:r,done:n,featureTotal:c,storyPointsAccepted:i,storyPointsInProgress:d,storyPointsPercentCompleted:l,defectsUnelaborated:p,defectsDefined:f,defectsInProgress:g,defectsCompleted:u,defectsAccepted:m,defectsReadyToShip:x,defectPointsAccepted:P,defectPointsInProgress:S}}});

            Rally.launchApp('CustomApp', {
                name:"S449643-ReleaseMenagementReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
