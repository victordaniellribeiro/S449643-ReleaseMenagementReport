<!DOCTYPE html>
<html>
<head>
    <title>S449643-ReleaseMenagementReport</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID;this.projectId=e,console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"}),a=Ext.create("Ext.panel.Panel",{title:"Release Menagement Report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:a});var o=Ext.create("Rally.ui.combobox.MilestoneComboBox",{fieldLabel:"Choose Milestone",width:250,itemId:"milestoneComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){console.log("ready: ",e)},select:function(e,t){console.log("comobo :",t);var a=Ext.create("Ext.data.JsonStore",{fields:["projectName","exploring","elaborating","inprogress","staging","done","featureTotal","storyPointsAccepted","storyPointsInProgress","storyPointsPercentCompleted","defectsUnelaborated","defectsDefined","defectsInProgress","defectsCompleted","defectsAccepted","defectsReadyToShip","defectPointsAccepted","defectPointsInProgress"]});this.myMask.show();for(var o=[],s=0;s<t.length;s++){var r=Ext.create("Deft.Deferred"),n=s;t[n].get("ObjectID");this._createDataCall(t[n],r,this),o.push(r)}Deft.Promise.all(o).then({success:function(e){a.add(e[0]);var t=Ext.create("Ext.grid.Panel",{height:650,columns:[{text:"Project Name",flex:1,sortable:!0,dataIndex:"projectName"},{text:"Features",columns:[{text:"Exploring",width:75,sortable:!0,dataIndex:"exploring"},{text:"Elaborating",width:75,sortable:!0,dataIndex:"elaborating"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"inprogress"},{text:"Staging",width:75,sortable:!0,dataIndex:"staging"},{text:"Done",width:75,sortable:!0,dataIndex:"done"},{text:"Total of Features",width:100,sortable:!0,dataIndex:"featureTotal"}]},{text:"Stories",columns:[{text:"Story Points Accepted",width:120,sortable:!0,dataIndex:"storyPointsAccepted"},{text:"Story Points In-Progress",width:130,sortable:!0,dataIndex:"storyPointsInProgress"},{text:"Percent Story Points Completed",width:170,sortable:!0,dataIndex:"storyPointsPercentCompleted"}]},{text:"Defects",columns:[{text:"Unelaborated",width:80,sortable:!0,dataIndex:"defectsUnelaborated"},{text:"Defined",width:70,sortable:!0,dataIndex:"defectsDefined"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"defectsInProgress"},{text:"Completed",width:75,sortable:!0,dataIndex:"defectsCompleted"},{text:"Accepted",width:75,sortable:!0,dataIndex:"defectsAccepted"},{text:"Read to Ship",width:80,sortable:!0,dataIndex:"defectsReadyToShip"},{text:"Defect Points Accepted",width:130,sortable:!0,dataIndex:"defectPointsAccepted"},{text:"Defect Points In-Progress",width:150,sortable:!0,dataIndex:"defectPointsInProgress"}]}],flex:1,store:a});this.down("#mainPanel").removeAll(!0),this.down("#mainPanel").add(t),this.myMask.hide()},scope:this})},scope:this}});t.add(o),this.add(t),this.add(a)},_createFeatureCall:function(e,t,a,o){new function(){this.deferred=a,this.that=o,this.execute=function(){console.log("executing feature call",e),this._loadFeatures(e)},this._loadFeatures=function(e){return console.log("loading stories and defects for project:",e),Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature","Defect","UserStory"],fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked","State","Type"],filters:[{property:"Project.ObjectID",operator:"=",value:e}],limit:1/0}).load().then({success:function(e){this.features=e;var o=this._createRow(t,e);a.resolve(o)},scope:this}),a.promise},this._createRow=function(e,t){var a=0,o=0,s=0,r=0,n=0,c=0,d=0,i=0,l=0,h=0,g=0,f=0,p=0,u=0,x=0,P=0,m=0,I=0;return _.each(t,function(e){"portfolioitem/feature"==e.get("_type")&&null!=e.get("State")&&("Exploring"==e.get("State").Name?a+=1:"Elaborating"==e.get("State").Name?o+=1:"In-Progress"==e.get("State").Name?s+=1:"Staging"==e.get("State").Name?r+=1:"Done"==e.get("State").Name&&(n+=1),c+=1),"hierarchicalrequirement"==e.get("_type")&&("Accepted"==e.get("ScheduleState")?d+=e.get("PlanEstimate"):"Defined"!=e.get("ScheduleState")&&"In-Progress"!=e.get("ScheduleState")||(i+=e.get("PlanEstimate")),h+=e.get("PlanEstimate")),"defect"==e.get("_type")&&("Unelaborated"==e.get("ScheduleState")?g+=1:"Defined"==e.get("ScheduleState")?(f+=1,I+=e.get("PlanEstimate")):"In-Progress"==e.get("ScheduleState")?(p+=1,I+=e.get("PlanEstimate")):"Completed"==e.get("ScheduleState")?u+=1:"Accepted"==e.get("ScheduleState")?(x+=1,m+=e.get("PlanEstimate")):"Ready to Ship"==e.get("ScheduleState")&&(P+=1))}),0!=h&&(l=Math.floor(i/h*100)+"%"),{projectName:e,exploring:a,elaborating:o,inprogress:s,staging:r,done:n,featureTotal:c,storyPointsAccepted:d,storyPointsInProgress:i,storyPointsPercentCompleted:l,defectsUnelaborated:g,defectsDefined:f,defectsInProgress:p,defectsCompleted:u,defectsAccepted:x,defectsReadyToShip:P,defectPointsAccepted:m,defectPointsInProgress:I}}}(e,a,o).execute()},_createDataCall:function(e,t,a){new function(){this.milestoneName=e.get("Name"),this.milestoneId=e.get("ObjectID"),this.deferred=t,this.that=a,this.execute=function(){console.log("executing call:",e),this._loadProjects(e).then({success:function(e){console.log("projects loaded")},scope:this})},this._loadProjects=function(e){return Ext.create("Rally.data.WsapiDataStore",{model:"Project",fetch:["Name","ObjectID","Children","Parent"],filters:Rally.data.QueryFilter.or([{property:"Parent.ObjectID",value:a.projectId},{property:"Parent.Parent.ObjectID",value:a.projectId}]),limit:1/0}).load().then({success:function(o){var s=[];_.each(o,function(e){0==e.get("Children").Count&&s.push(e.get("ObjectID"))}),console.log("child projects",s),e.getCollection("Projects",{fetch:["Name","ObjectID","Children","Parent"]}).load({callback:function(e,o,r){var n=[];_.each(e,function(e){var t=e.get("ObjectID");if(Ext.Array.contains(s,t)){var o=Ext.create("Deft.Deferred"),r=e.get("Name");a._createFeatureCall(t,r,o,this),n.push(o)}}),Deft.Promise.all(n).then({success:function(e){t.resolve(e)},scope:this})},scope:this})},scope:this}),t.promise}}(e,t,a).execute()}});

            Rally.launchApp('CustomApp', {
                name:"S449643-ReleaseMenagementReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
