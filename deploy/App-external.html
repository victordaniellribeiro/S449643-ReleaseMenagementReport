<!DOCTYPE html>
<html>
<head>
    <title>S449643-ReleaseMenagementReport</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"}),o=Ext.create("Ext.panel.Panel",{title:"Release Menagement Report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:o});var a=Ext.create("Rally.ui.combobox.MilestoneComboBox",{fieldLabel:"Choose Milestone",width:250,itemId:"milestoneComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){console.log("ready: ",e)},select:function(e,t){console.log("comobo :",t);var o=Ext.create("Ext.data.JsonStore",{fields:["projectName","exploring","elaborating","inprogress","staging","done","featureTotal","storyPointsAccepted","storyPointsInProgress","storyPointsPercentCompleted","defectsUnelaborated","defectsDefined","defectsInProgress","defectsCompleted","defectsAccepted","defectsReadyToShip","defectPointsAccepted","defectPointsInProgress"]});this.myMask.show();for(var a=[],s=0;s<t.length;s++){var n=Ext.create("Deft.Deferred"),r=s;t[r].get("ObjectID");this._createDataCall(t[r],n,this),a.push(n)}Deft.Promise.all(a).then({success:function(e){o.add(e[0]),console.log("creating grid"),console.log("report store:",o);var t=Ext.create("Ext.grid.Panel",{height:650,columns:[{text:"Project Name",flex:1,sortable:!0,dataIndex:"projectName"},{text:"Features",columns:[{text:"Exploring",width:75,sortable:!0,dataIndex:"exploring"},{text:"Elaborating",width:75,sortable:!0,dataIndex:"elaborating"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"inprogress"},{text:"Staging",width:75,sortable:!0,dataIndex:"staging"},{text:"Done",width:75,sortable:!0,dataIndex:"done"},{text:"Total of Features",width:100,sortable:!0,dataIndex:"featureTotal"}]},{text:"Stories",columns:[{text:"Story Points Accepted",width:120,sortable:!0,dataIndex:"storyPointsAccepted"},{text:"Story Points In-Progress",width:130,sortable:!0,dataIndex:"storyPointsInProgress"},{text:"Percent Story Points Completed",width:170,sortable:!0,dataIndex:"storyPointsPercentCompleted"}]},{text:"Defects",columns:[{text:"Unelaborated",width:80,sortable:!0,dataIndex:"defectsUnelaborated"},{text:"Defined",width:70,sortable:!0,dataIndex:"defectsDefined"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"defectsInProgress"},{text:"Completed",width:75,sortable:!0,dataIndex:"defectsCompleted"},{text:"Accepted",width:75,sortable:!0,dataIndex:"defectsAccepted"},{text:"Read to Ship",width:80,sortable:!0,dataIndex:"defectsReadyToShip"},{text:"Defect Points Accepted",width:130,sortable:!0,dataIndex:"defectPointsAccepted"},{text:"Defect Points In-Progress",width:150,sortable:!0,dataIndex:"defectPointsInProgress"}]}],flex:1,store:o});this.down("#mainPanel").removeAll(!0),this.down("#mainPanel").add(t),this.myMask.hide()},scope:this})},scope:this}});t.add(a),this.add(t),this.add(o)},_createFeatureCall:function(e,t,o,a){new function(){this.deferred=o,this.that=a,this.execute=function(){console.log("executing feature call",e),this._loadFeatures(e)},this._loadFeatures=function(e){return console.log("loading stories and defects for project:",e),Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature","Defect","UserStory"],fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","Blocked","State","Type"],filters:[{property:"Project.ObjectID",operator:"=",value:e}],limit:1/0}).load().then({success:function(e){this.features=e,console.log("Features:",e);var a=this._createRow(t,e);o.resolve(a)},scope:this}),o.promise},this._createRow=function(e,t){var o=0,a=0,s=0,n=0,r=0,d=0,c=0,l=0,i=0,g=0,h=0,f=0,p=0,x=0,u=0,m=0,P=0,I=0;_.each(t,function(e){"portfolioitem/feature"==e.get("_type")&&null!=e.get("State")&&("Exploring"==e.get("State").Name?o+=1:"Elaborating"==e.get("State").Name?a+=1:"In-Progress"==e.get("State").Name?s+=1:"Staging"==e.get("State").Name?n+=1:"Done"==e.get("State").Name&&(r+=1),d+=1),"hierarchicalrequirement"==e.get("_type")&&("Accepted"==e.get("ScheduleState")?c+=e.get("PlanEstimate"):"Defined"!=e.get("ScheduleState")&&"In-Progress"!=e.get("ScheduleState")||(l+=e.get("PlanEstimate")),g+=e.get("PlanEstimate")),"defect"==e.get("_type")&&("Unelaborated"==e.get("ScheduleState")?h+=1:"Defined"==e.get("ScheduleState")?(f+=1,I+=e.get("PlanEstimate")):"In-Progress"==e.get("ScheduleState")?(p+=1,I+=e.get("PlanEstimate")):"Completed"==e.get("ScheduleState")?x+=1:"Accepted"==e.get("ScheduleState")?(u+=1,P+=e.get("PlanEstimate")):"Ready to Ship"==e.get("ScheduleState")&&(m+=1))}),0!=g&&(i=Math.floor(l/g*100)+"%");var b={projectName:e,exploring:o,elaborating:a,inprogress:s,staging:n,done:r,featureTotal:d,storyPointsAccepted:c,storyPointsInProgress:l,storyPointsPercentCompleted:i,defectsUnelaborated:h,defectsDefined:f,defectsInProgress:p,defectsCompleted:x,defectsAccepted:u,defectsReadyToShip:m,defectPointsAccepted:P,defectPointsInProgress:I};return console.log("project row:",b),b}}(e,o,a).execute()},_createDataCall:function(e,t,o){new function(){this.milestoneName=e.get("Name"),this.milestoneId=e.get("ObjectID"),this.deferred=t,this.that=o,this.execute=function(){console.log("executing call:",e),this._loadProjects(e).then({success:function(e){console.log("projects loaded")},scope:this})},this._loadProjects=function(e){return console.log("loading projects for milestone:",e),e.getCollection("Projects",{fetch:["Name","ObjectID","Children"]}).load({callback:function(e,a,s){console.log("projects loaded:",e);var n=[];_.each(e,function(e){if(0==e.get("Children").Count){var t=Ext.create("Deft.Deferred"),a=e.get("ObjectID"),s=e.get("Name");console.log(),o._createFeatureCall(a,s,t,this),n.push(t)}}),Deft.Promise.all(n).then({success:function(e){console.log("end promises - feature:",e),t.resolve(e)},scope:this})},scope:this}),t.promise}}(e,t,o).execute()}});

            Rally.launchApp('CustomApp', {
                name:"S449643-ReleaseMenagementReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
