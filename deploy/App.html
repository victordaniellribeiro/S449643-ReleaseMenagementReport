<!DOCTYPE html>
<html>
<head>
    <title>S449643-ReleaseMenagementReport</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_releaseId:void 0,_releaseDate:void 0,_releaseInitDate:void 0,_releaseEndDate:void 0,_stories:void 0,_defects:void 0,_orphanDefects:void 0,_features:void 0,_defaultWorkDays:60,launch:function(){var e=this.getContext().getProject().ObjectID;this.projectId=e,console.log("project:",e);var t=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"}),a=Ext.create("Ext.panel.Panel",{title:"Summary",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"summaryPanel",items:[{xtype:"container",itemId:"notes",padding:"0 0 10 0",html:"* Percentage that should be complete is calculated by the total number of  work days that have elapsed by the number of work days in a release"}]}),o=Ext.create("Ext.panel.Panel",{title:"Release Menagement Report",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"mainPanel"});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var s=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:450,itemId:"releasaeComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){var t=[e.getRecord()];this._releaseInitDate=e.getRecord().get("ReleaseStartDate"),this._releaseEndDate=e.getRecord().get("ReleaseDate"),this._setDefaultWorkDays(),this._initReport(t)},select:function(e,t){this._releaseInitDate=e.getRecord().get("ReleaseStartDate"),this._releaseEndDate=e.getRecord().get("ReleaseDate"),this._setDefaultWorkDays(),this._initReport(t)},scope:this}});t.add(s),this.add(t),this.add(a),this.add(o)},_setDefaultWorkDays:function(){var e,t=Math.ceil((this._releaseEndDate.getTime()-this._releaseInitDate.getTime())/864e5);console.log("release total days:",t),e=t-t/7*2,console.log("setting default work days:",e),this._defaultWorkDays=e},_initReport:function(e){this.myMask.show();for(var t=[],a=0;a<e.length;a++){var o=Ext.create("Deft.Deferred"),s=a;this._releaseId=e[s].get("ObjectID"),this._releaseDate=e[s].get("ReleaseDate"),this._createDataCall(e[s],o,this),t.push(o)}Deft.Promise.all(t).then({success:function(e){var t=e[0],a=this._createReportGrid(t),o=this._createSummaryGrid();this.down("#mainPanel").removeAll(!0),this.down("#summaryPanel").add(o),this.down("#mainPanel").add(a),this.myMask.hide()},scope:this})},_createReportGrid:function(e){var t=Ext.create("Ext.data.JsonStore",{fields:["projectName","exploring","elaborating","inprogress","staging","done","featureTotal","storyPointsAccepted","storyPointsInProgress","storyPointsPercentCompleted","defectsUnelaborated","defectsDefined","defectsInProgress","defectsCompleted","defectsAccepted","defectsReadyToShip","defectPointsAccepted","defectPointsInProgress"]});return t.add(e),Ext.create("Ext.grid.Panel",{columns:[{text:"Project Name",flex:1,sortable:!0,dataIndex:"projectName"},{text:"Features",flex:3,columns:[{text:"Exploring",width:75,sortable:!0,dataIndex:"exploring"},{text:"Elaborating",width:75,sortable:!0,dataIndex:"elaborating"},{text:"In-Progress",width:75,sortable:!0,dataIndex:"inprogress"},{text:"Staging",width:75,sortable:!0,dataIndex:"staging"},{text:"Done",width:75,sortable:!0,dataIndex:"done"},{text:"Total of Features",width:80,sortable:!0,dataIndex:"featureTotal"}]},{text:"Stories",flex:2,columns:[{text:"Story Points Accepted",sortable:!0,dataIndex:"storyPointsAccepted"},{text:"Story Points In-Progress",sortable:!0,dataIndex:"storyPointsInProgress"},{text:"Percent Story Points Completed",sortable:!0,dataIndex:"storyPointsPercentCompleted"}]},{text:"Defects",flex:4,columns:[{text:"Unelaborated",width:85,sortable:!0,dataIndex:"defectsUnelaborated"},{text:"Defined",width:55,sortable:!0,dataIndex:"defectsDefined"},{text:"In-Progress",width:65,sortable:!0,dataIndex:"defectsInProgress"},{text:"Completed",width:65,sortable:!0,dataIndex:"defectsCompleted"},{text:"Accepted",width:65,sortable:!0,dataIndex:"defectsAccepted"},{text:"Read to Ship",width:70,sortable:!0,dataIndex:"defectsReadyToShip"},{text:"Defect Points Accepted",width:120,sortable:!0,dataIndex:"defectPointsAccepted"},{text:"Defect Points In-Progress",width:130,sortable:!0,dataIndex:"defectPointsInProgress"}]}],flex:1,store:t})},_createSummaryGrid:function(){var e,t,a=Ext.create("Ext.data.JsonStore",{fields:["daysRemaining","workingDaysRemaining","totalStoryPoints","totalStoryPointsAccepted","totalDefectPoints","totalDefectPointsAccepted","totalFeaturePoints","totalFeaturePointsCompleted","percentageComplete","percentageShouldBeCompleted"]}),o=this._releaseDate,s=new Date,r=Math.ceil((o.getTime()-s.getTime())/864e5),n=r-2*Math.ceil(r/7),i=0,d=0,l=0,c=0,h=0,p=0;_.each(this._stories,function(e){i+=e.get("PlanEstimate"),"Accepted"!==e.get("ScheduleState")&&"Ready to Ship"!==e.get("ScheduleState")||(d+=e.get("PlanEstimate"))}),_.each(this._defects,function(e){l+=e.get("PlanEstimate"),"Accepted"!==e.get("ScheduleState")&&"Ready to Ship"!==e.get("ScheduleState")||(c+=e.get("PlanEstimate"))}),_.each(this._orphanDefects,function(e){l+=e.get("PlanEstimate"),"Accepted"!==e.get("ScheduleState")&&"Ready to Ship"!==e.get("ScheduleState")||(c+=e.get("PlanEstimate"))}),_.each(this._features,function(e){var t=e.get("State");h+=e.get("PreliminaryEstimateValue"),!t||"Staging"!==t.Name&&"Done"!==t.Name||(p+=e.get("PreliminaryEstimateValue"))}),e=((d+c)/(i+l)*100).toFixed(2)+"%",t=((this._defaultWorkDays-n)/this._defaultWorkDays*100).toFixed(2)+"%";var f=[],g={daysRemaining:r,workingDaysRemaining:n,totalStoryPoints:i,totalStoryPointsAccepted:d,totalDefectPoints:l,totalDefectPointsAccepted:c,totalFeaturePoints:h,totalFeaturePointsCompleted:p,percentageComplete:e,percentageShouldBeCompleted:t};return f.push(g),a.add(f),Ext.create("Ext.grid.Panel",{columns:[{text:"Days Remaining",sortable:!0,flex:1,dataIndex:"daysRemaining"},{text:"Working Days Remaining",sortable:!0,flex:1,dataIndex:"workingDaysRemaining"},{text:"Total Story Points",sortable:!0,flex:1,dataIndex:"totalStoryPoints"},{text:"Total Story Points Accepted",sortable:!0,flex:1,dataIndex:"totalStoryPointsAccepted"},{text:"Total Defect Points",sortable:!0,flex:1,dataIndex:"totalDefectPoints"},{text:"Total Defect Points Accepted",sortable:!0,flex:1,dataIndex:"totalDefectPointsAccepted"},{text:"Total Feature Points",sortable:!0,flex:1,dataIndex:"totalFeaturePoints"},{text:"Total Feature Points Completed",sortable:!0,flex:1,dataIndex:"totalFeaturePointsCompleted"},{text:"Percentage Completed",sortable:!0,flex:1,dataIndex:"percentageComplete",renderer:function(e,t,a){return parseFloat(e)>parseFloat(a.get("percentageShouldBeCompleted"))?t.style="background-color:#cdf9c2;":t.style="background-color:#ffe2e2;",e}},{text:"Percentage That Should Be Completed",flex:1,sortable:!0,dataIndex:"percentageShouldBeCompleted"}],flex:1,store:a})},_createDataCall:function(e,t,a){new function(){this.releaseName=e.get("Name"),this.releaseId=e.get("ObjectID"),this.deferred=t,this.that=a;var o=a.getContext();this.projectId=o.getProject().ObjectID,this.execute=function(){this._loadOrphanDefects(this.releaseName,this.projectId).then({success:function(e){return this.orphanDefects=e,a._orphanDefects=e,this._loadFeatures(this.releaseName)},scope:this}).then({success:function(e){return this.features=_.flatten(e),a._features=this.features,this._loadStories(e)},scope:this}).then({success:function(e){return this.stories=_.flatten(e),a._stories=this.stories,this._loadDefects(e)},scope:this}).then({success:function(e){this.defects=_.flatten(e),a._defects=this.defects;var o=[];a._createProjectMap(this.features,this.stories,this.defects,this.orphanDefects).eachKey(function(e,t){o.push(a._createRow(e,t))}),t.resolve(o)},scope:this})},this._loadFeatures=function(e){return Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:"/project/"+this.projectId},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","PreliminaryEstimate","PreliminaryEstimateValue","Project","State","Type","UserStories"],filters:[{property:"Release.Name",operator:"=",value:e}],limit:1/0}).load()},this._loadStories=function(e){var t=[];return _.each(e,function(e){var a=e.get("UserStories");a.Count>0&&(a.store=e.getCollection("UserStories",{fetch:["FormattedID","Name","ObjectID","Children","Defects","ScheduleState","Project","PlanEstimate","Type"]}),t.push(a.store.load()))}),Deft.Promise.all(t)},this._loadDefects=function(e){e=_.flatten(e);var t=[];return _.each(e,function(e){var a=e.get("Defects");a.Count>0&&(a.store=e.getCollection("Defects",{fetch:["FormattedID","Name","ObjectID","ScheduleState","Project","PlanEstimate","Blocked","Type","Parent"]}),t.push(a.store.load()))}),Deft.Promise.all(t)},this._loadOrphanDefects=function(e,t){return Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:/project/+t},models:["Defect"],fetch:["FormattedID","Name","ObjectID","Project","PlanEstimate","ScheduleState","Type","Blocked","Parent"],filters:[{property:"Release.Name",operator:"=",value:e}],limit:1/0}).load()}}(e,t,a).execute()},_createProjectMap:function(e,t,a,o){var s=new Ext.util.MixedCollection;return _.each(e,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(t,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(a,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),_.each(o,function(e){var t=e.get("Project").Name;if(s.containsKey(t))s.get(t).push(e);else{var a=[];a.push(e),s.add(t,a)}}),s},_createRow:function(e,t){var a=0,o=0,s=0,r=0,n=0,i=0,d=0,l=0,c=0,h=0,p=0,f=0,g=0,u=0,m=0,x=0,P=0,S=0;return _.each(t,function(e){"portfolioitem/feature"==e.get("_type")&&null!=e.get("State")&&("Exploring"==e.get("State").Name?a+=1:"Elaborating"==e.get("State").Name?o+=1:"In-Progress"==e.get("State").Name?s+=1:"Staging"==e.get("State").Name?r+=1:"Done"==e.get("State").Name&&(n+=1),i+=1),"hierarchicalrequirement"==e.get("_type")&&("Accepted"==e.get("ScheduleState")||"Ready to Ship"==e.get("ScheduleState")?d+=e.get("PlanEstimate"):"Accepted"!=e.get("ScheduleState")&&"Ready to Ship"!=e.get("ScheduleState")&&(l+=e.get("PlanEstimate")),h+=e.get("PlanEstimate")),"defect"==e.get("_type")&&("Unelaborated"==e.get("ScheduleState")?p+=1:"Defined"==e.get("ScheduleState")?(f+=1,S+=e.get("PlanEstimate")):"In-Progress"==e.get("ScheduleState")?(g+=1,S+=e.get("PlanEstimate")):"Completed"==e.get("ScheduleState")?u+=1:"Accepted"==e.get("ScheduleState")?(m+=1,P+=e.get("PlanEstimate")):"Ready to Ship"==e.get("ScheduleState")&&(x+=1))}),0!=h&&(c=Math.floor(d/h*100)+"%"),{projectName:e,exploring:a,elaborating:o,inprogress:s,staging:r,done:n,featureTotal:i,storyPointsAccepted:d,storyPointsInProgress:l,storyPointsPercentCompleted:c,defectsUnelaborated:p,defectsDefined:f,defectsInProgress:g,defectsCompleted:u,defectsAccepted:m,defectsReadyToShip:x,defectPointsAccepted:P,defectPointsInProgress:S}}});

            Rally.launchApp('CustomApp', {
                name:"S449643-ReleaseMenagementReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .x-column-header-inner .x-column-header-text{white-space:normal}.x-column-header-inner{line-height:normal;padding-top:3px !important;padding-bottom:3px !important;text-align:center;top:20%}
    </style>
</head>
<body>
</body>
</html>
